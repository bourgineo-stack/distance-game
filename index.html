<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Jeu de proximit√©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    input, button, select {
      padding: 15px 20px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      width: 100%;
    }
    input, select {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }
    button {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #cccccc; }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .qrcode-container {
      text-align: center;
      margin: 20px 0;
    }
    #qrcode {
      display: inline-block;
      background: white;
      padding: 10px;
      border-radius: 12px;
    }
    .participant-card {
      background: rgba(255, 255, 255, 0.2);
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }
    .distance-badge {
      background: #ffd700;
      color: #333;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      float: right;
    }
    .question-bubble {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4CAF50;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
    }
    .scan-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .progress-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s ease;
    }
    .map-container {
      width: 100%;
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin: 20px 0;
      position: relative;
      overflow: hidden;
    }
    .map-point {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #4CAF50;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    .map-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    h2 { text-align: center; margin-bottom: 20px; }
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .step-dot {
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
    }
    .step-dot.active {
      background: #4CAF50;
    }
    .error-message {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid red;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Indicateur d'√©tapes -->
    <div class="step-indicator">
      <div class="step-dot active" id="step1Dot"></div>
      <div class="step-dot" id="step2Dot"></div>
      <div class="step-dot" id="step3Dot"></div>
    </div>

    <!-- √âtape 1 : Flashage libre avec questions -->
    <div id="step1" class="step active">
      <h2>üéØ √âtape 1 : Rencontres & Questions</h2>
      <p>Scannez un maximum de personnes ! √Ä chaque fois que vous trouvez quelqu'un √† moins de 10km, une question s'affiche pour briser la glace.</p>
      
      <div class="error-message" id="errorMessage"></div>
      
      <input id="userAddress" placeholder="üìç Entrez votre adresse ou ville" />
      <button id="saveLocation">Valider ma localisation</button>
      
      <div class="qrcode-container" id="qrcodeContainer" style="display: none;">
        <p>Votre code √† partager :</p>
        <div id="qrcode"></div>
      </div>

      <div id="scanSection" style="display: none;">
        <button id="scanBtn" class="scan-animation">üì± Scanner un code</button>
        <button id="stopScanBtn" style="display: none; background: #ff6b6b;">üõë Arr√™ter</button>
        <div id="scanResult"></div>
      </div>

      <div id="questionSection" style="display: none;">
        <div class="question-bubble" id="questionBubble"></div>
      </div>

      <div class="progress-bar">
        <div class="progress" id="step1Progress" style="width: 0%"></div>
      </div>
      <p>Personnes scann√©es : <span id="scanCount">0</span></p>
    </div>

    <!-- √âtape 2 : Top 5 des plus proches -->
    <div id="step2" class="step">
      <h2>üåü √âtape 2 : Vos 5 plus proches voisins</h2>
      <p>Retrouvez et connectez-vous avec les personnes qui habitent le plus pr√®s de chez vous !</p>
      
      <div id="top5List"></div>
      
      <button onclick="showStep(1)">‚¨ÖÔ∏è Retour au scan</button>
      <button onclick="showStep(3)" id="nextToStep3" style="display: none;">‚û°Ô∏è Passer √† la carte</button>
    </div>

    <!-- √âtape 3 : Carte collective -->
    <div id="step3" class="step">
      <h2>üó∫Ô∏è √âtape 3 : Carte du territoire</h2>
      <p>Le centre de la pi√®ce repr√©sente le lieu de travail. Positionnez-vous sur la carte !</p>
      
      <select id="workAddress">
        <option value="">S√©lectionnez le lieu de travail</option>
        <option value="48.8566,2.3522">Paris (exemple)</option>
        <option value="45.7640,4.8357">Lyon (exemple)</option>
        <option value="43.2965,5.3698">Marseille (exemple)</option>
      </select>
      
      <div class="map-container" id="mapContainer">
        <div class="map-center"></div>
        <!-- Les points seront ajout√©s dynamiquement -->
      </div>
      
      <div id="mapLegend"></div>
      
      <button onclick="showStep(2)">‚¨ÖÔ∏è Retour aux voisins</button>
    </div>

    <!-- Cam√©ra -->
    <video id="video" autoplay playsinline muted style="display: none; width: 100%; border-radius: 12px;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let myCoords = null;
    let participants = [];
    let scanning = false;
    let animationFrameId = null;
    let workCoords = null;
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');

    // Questions amusantes pour briser la glace
    const questions = [
      "Quel est ton fruit pr√©f√©r√© ? üçéüçåüçá",
      "Plut√¥t chien ou chat ? üê∂üê±",
      "Quelle est ta s√©rie du moment ? üì∫",
      "Plut√¥t mer ou montagne ? üåä‚õ∞Ô∏è",
      "Quel est ton plat pr√©f√©r√© ? üçïüçù",
      "Plut√¥t caf√© ou th√© ? ‚òïüçµ",
      "Quel est ton super-pouvoir secret ? ü¶∏‚Äç‚ôÇÔ∏è",
      "Plut√¥t livre ou film ? üìöüé¨",
      "Quelle est ta chanson du moment ? üéµ",
      "Plut√¥t sport ou d√©tente ? üèÉ‚Äç‚ôÇÔ∏èüõãÔ∏è",
      "Quel est ton r√™ve de voyage ? ‚úàÔ∏è",
      "Plut√¥t matin ou soir ? üåÖüåÉ",
      "Quel est ton jeu vid√©o pr√©f√©r√© ? üéÆ",
      "Plut√¥t sucr√© ou sal√© ? üç∞üçï"
    ];

    // Afficher les erreurs
    function showError(message) {
      const errorDiv = $('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Calcul de distance
    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }

    // G√©ocodage avec gestion adresse/ville
    async function geocode(location) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&addressdetails=1`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.length === 0) throw new Error('Localisation non trouv√©e');
      
      return { 
        lat: parseFloat(data[0].lat), 
        lon: parseFloat(data[0].lon), 
        displayName: data[0].display_name,
        address: data[0].address
      };
    }

    // G√©n√©ration QR Code avec donn√©es r√©duites
    function genMyQRCode() {
      $('qrcode').innerHTML = '';
      
      // Donn√©es r√©duites pour √©viter l'erreur de taille
      const qrData = {
        lat: myCoords.lat.toFixed(6), // R√©duire la pr√©cision
        lon: myCoords.lon.toFixed(6),
        n: myCoords.shortName, // Nom court seulement
        t: Date.now()
      };
      
      try {
        new QRCode($('qrcode'), {
          text: JSON.stringify(qrData),
          width: 180,
          height: 180,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M // Niveau de correction plus bas pour plus de capacit√©
        });
      } catch (error) {
        showError("Erreur g√©n√©ration QR code: " + error.message);
        console.error("QR Code error:", error);
      }
    }

    // Navigation entre √©tapes
    function showStep(stepNumber) {
      // Cacher toutes les √©tapes
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.querySelectorAll('.step-dot').forEach(dot => dot.classList.remove('active'));
      
      // Afficher l'√©tape demand√©e
      $(`step${stepNumber}`).classList.add('active');
      $(`step${stepNumber}Dot`).classList.add('active');
      
      // Arr√™ter la cam√©ra si on quitte l'√©tape 1
      if (stepNumber !== 1) {
        stopCamera();
      }
      
      // Mettre √† jour les vues
      if (stepNumber === 2) {
        updateTop5View();
      } else if (stepNumber === 3) {
        updateMapView();
      }
    }

    // Ajouter un participant avec question si <10km
    function addParticipant(lat, lon, address) {
      // √âviter les doublons
      const existing = participants.find(p => p.lat === lat && p.lon === lon);
      if (existing) return false;
      
      const distance = haversineKm(myCoords.lat, myCoords.lon, lat, lon);
      const participant = {
        lat,
        lon,
        address,
        distance,
        timestamp: Date.now(),
        id: Math.random().toString(36).substr(2, 9)
      };
      
      participants.push(participant);
      participants.sort((a, b) => a.distance - b.distance);
      
      // Mettre √† jour le compteur et la progression
      updateProgress();
      
      // Si distance < 10km, afficher une question
      if (distance < 10) {
        showRandomQuestion();
      }
      
      // Activer le bouton vers l'√©tape 3 si on a au moins 5 participants
      if (participants.length >= 5) {
        $('nextToStep3').style.display = 'block';
      }
      
      return true;
    }

    // Afficher une question al√©atoire
    function showRandomQuestion() {
      const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
      $('questionBubble').textContent = randomQuestion;
      $('questionSection').style.display = 'block';
      
      // Cacher la question apr√®s 10 secondes
      setTimeout(() => {
        $('questionSection').style.display = 'none';
      }, 10000);
    }

    // Mettre √† jour la progression
    function updateProgress() {
      const scanCount = participants.length;
      $('scanCount').textContent = scanCount;
      
      // Progression bas√©e sur le nombre de scans (max 20 pour 100%)
      const progress = Math.min((scanCount / 20) * 100, 100);
      $('step1Progress').style.width = `${progress}%`;
    }

    // Vue Top 5
    function updateTop5View() {
      const container = $('top5List');
      container.innerHTML = '';
      
      const top5 = participants.slice(0, 5);
      
      if (top5.length === 0) {
        container.innerHTML = '<p style="text-align:center;">Scannez d\'abord quelques personnes !</p>';
        return;
      }
      
      top5.forEach((participant, index) => {
        const card = document.createElement('div');
        card.className = 'participant-card';
        
        let medal = '';
        if (index === 0) medal = 'ü•á ';
        else if (index === 1) medal = 'ü•à ';
        else if (index === 2) medal = 'ü•â ';
        
        card.innerHTML = `
          <strong>${medal}${participant.address.split(',')[0]}</strong>
          <span class="distance-badge">${participant.distance.toFixed(1)} km</span>
          <div style="clear:both;"></div>
          <small>${participant.address}</small>
        `;
        container.appendChild(card);
      });
    }

    // Vue Carte
    function updateMapView() {
      const container = $('mapContainer');
      const legend = $('mapLegend');
      
      // Nettoyer la carte
      container.querySelectorAll('.map-point').forEach(point => point.remove());
      legend.innerHTML = '';
      
      if (!workCoords || participants.length === 0) {
        legend.innerHTML = '<p>S√©lectionnez un lieu de travail et scannez des personnes</p>';
        return;
      }
      
      // Ajouter les participants sur la carte
      participants.forEach(participant => {
        const point = document.createElement('div');
        point.className = 'map-point';
        
        // Position relative par rapport au centre (lieu de travail)
        const latDiff = participant.lat - workCoords.lat;
        const lonDiff = participant.lon - workCoords.lon;
        
        // Conversion approximative en pixels (1 degr√© = 100 pixels)
        const x = 50 + (lonDiff * 5000);
        const y = 50 - (latDiff * 5000);
        
        point.style.left = `${Math.max(10, Math.min(90, x))}%`;
        point.style.top = `${Math.max(10, Math.min(90, y))}%`;
        point.title = `${participant.address.split(',')[0]} (${participant.distance.toFixed(1)}km)`;
        
        container.appendChild(point);
      });
      
      // L√©gende
      legend.innerHTML = `
        <p><strong>L√©gende :</strong></p>
        <p>üî¥ Centre : Lieu de travail</p>
        <p>üü¢ Points : Participants</p>
        <p>${participants.length} personne(s) sur la carte</p>
      `;
    }

    // Gestion cam√©ra
    function stopCamera() {
      scanning = false;
      $('#stopScanBtn').style.display = 'none';
      $('#scanBtn').style.display = 'block';
      $('#scanBtn').classList.add('scan-animation');
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      video.style.display = 'none';
    }

    function startScanLoop() {
      scanning = true;
      $('#scanBtn').style.display = 'none';
      $('#scanBtn').classList.remove('scan-animation');
      $('#stopScanBtn').style.display = 'block';
      video.style.display = 'block';
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' }
      }).then(stream => {
        video.srcObject = stream;
        video.play();
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
              });
              
              if (code) {
                try {
                  const parsed = JSON.parse(code.data);
                  if (parsed.lat && parsed.lon) {
                    const address = parsed.n || 'Localit√© inconnue';
                    
                    if (addParticipant(parseFloat(parsed.lat), parseFloat(parsed.lon), address)) {
                      $('#scanResult').innerHTML = `
                        <div style="color:#4CAF50; text-align:center; margin:10px 0;">
                          ‚úÖ Connect√© ! Distance: ${haversineKm(myCoords.lat, myCoords.lon, parseFloat(parsed.lat), parseFloat(parsed.lon)).toFixed(1)} km
                        </div>
                      `;
                    } else {
                      $('#scanResult').innerHTML = `
                        <div style="color:#ff9800; text-align:center; margin:10px 0;">
                          ‚ö†Ô∏è D√©j√† connect√© avec cette personne
                        </div>
                      `;
                    }
                    return;
                  }
                } catch (e) {
                  console.log('QR code invalide');
                  $('#scanResult').innerHTML = `
                    <div style="color:#ff6b6b; text-align:center; margin:10px 0;">
                      ‚ùå QR code non reconnu
                    </div>
                  `;
                }
              }
            } catch (error) {
              console.log('Erreur analyse QR:', error);
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        showError('Erreur acc√®s cam√©ra: ' + e.message);
        stopCamera();
      });
    }

    // √âv√©nements
    $('saveLocation').addEventListener('click', async () => {
      const location = $('userAddress').value.trim();
      if (!location) {
        showError('Entrez votre localisation');
        return;
      }
      
      try {
        const res = await geocode(location);
        myCoords = { 
          lat: res.lat, 
          lon: res.lon, 
          displayName: res.displayName,
          shortName: res.displayName.split(',')[0] // Nom court pour le QR code
        };
        
        $('qrcodeContainer').style.display = 'block';
        $('scanSection').style.display = 'block';
        genMyQRCode();
        
        $('#scanResult').innerHTML = `
          <div style="color:#4CAF50; text-align:center;">
            ‚úÖ Localisation enregistr√©e : ${res.displayName.split(',')[0]}
          </div>
        `;
        
      } catch (e) {
        showError('Erreur: ' + e.message);
      }
    });

    $('scanBtn').addEventListener('click', startScanLoop);
    $('stopScanBtn').addEventListener('click', stopCamera);

    $('workAddress').addEventListener('change', function() {
      if (this.value) {
        const [lat, lon] = this.value.split(',').map(Number);
        workCoords = { lat, lon };
        updateMapView();
      }
    });

    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
