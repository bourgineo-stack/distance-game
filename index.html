<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Covoiturage</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    input, button, select {
      padding: 15px 20px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      width: 100%;
    }
    input, select {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }
    button {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #cccccc; }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .qrcode-container {
      text-align: center;
      margin: 20px 0;
    }
    #qrcode {
      display: inline-block;
      background: white;
      padding: 10px;
      border-radius: 12px;
      min-height: 200px;
      min-width: 200px;
    }
    .participant-card {
      background: rgba(255, 255, 255, 0.2);
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }
    .participant-card.target {
      border-left: 4px solid #ffd700;
      background: rgba(255, 215, 0, 0.2);
    }
    .participant-card.scanned {
      border-left: 4px solid #4CAF50;
      background: rgba(76, 175, 80, 0.3);
    }
    .distance-badge {
      background: #ffd700;
      color: #333;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      float: right;
    }
    .question-bubble {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4CAF50;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
    }
    .question-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }
    .question-option {
      flex: 1;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
    }
    .question-option:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    .question-option.selected {
      background: rgba(76, 175, 80, 0.4);
      border-color: #4CAF50;
    }
    .scan-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .progress-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s ease;
    }
    h2 { text-align: center; margin-bottom: 20px; }
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
    }
    .step-dot {
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
    }
    .step-dot.active {
      background: #4CAF50;
    }
    .error-message {
      background: rgba(255, 0, 0, 0.2);
      border: 1px solid red;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      display: none;
    }
    .success-message {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      display: none;
    }
    .navigation-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .navigation-buttons button {
      flex: 1;
    }
    .address-preview {
      background: rgba(255, 255, 255, 0.15);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9em;
    }
    .game-stats {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
    }
    .score-badge {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 1.2rem;
      font-weight: bold;
      margin: 10px 0;
      display: inline-block;
    }
    .attempts-counter {
      font-size: 1.1rem;
      margin: 10px 0;
    }
    .target-list {
      margin: 20px 0;
    }
    .game-instructions {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
    }
    .continue-btn {
      background: #2196F3;
      margin-top: 10px;
    }
    .continue-btn:disabled {
      background: #cccccc;
    }
    .location-section {
      transition: all 0.3s ease;
    }
    .location-section.completed {
      opacity: 0.7;
    }
    .completed-message {
      color: #4CAF50;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }
    .distance-info {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid #ffd700;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Indicateur d'√©tapes -->
    <div class="step-indicator">
      <div class="step-dot active" id="step1Dot"></div>
      <div class="step-dot" id="step2Dot"></div>
    </div>

    <!-- √âtape 1 : Flashage libre avec questions -->
    <div id="step1" class="step active">
      <h2>üéØ √âtape 1 : Rencontres & Questions</h2>
      <p>Scannez un maximum de personnes ! √Ä chaque fois que vous trouvez quelqu'un √† moins de 10km, une question √† poser !</p>
      
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>
      
      <!-- Section localisation - masqu√©e apr√®s validation -->
      <div id="locationSection" class="location-section">
        <input id="userAddress" placeholder="üìç Entrez votre adresse compl√®te" />
        <button id="saveLocation">Valider ma localisation</button>
      </div>

      <!-- Section affich√©e apr√®s validation de la localisation -->
      <div id="afterLocationSection" style="display: none;">
        <div class="completed-message">
          ‚úÖ Localisation enregistr√©e
        </div>
        <div id="addressPreview" class="address-preview">
          <strong>Adresse d√©tect√©e :</strong> <span id="detectedAddress"></span>
        </div>

        <div class="qrcode-container" id="qrcodeContainer">
          <p>Votre code √† partager :</p>
          <div id="qrcode"></div>
        </div>

        <div id="scanSection">
          <button id="scanBtn" class="scan-animation">üì± Scanner un code</button>
          <button id="stopScanBtn" style="display: none; background: #ff6b6b;">üõë Arr√™ter</button>
          <div id="scanResult"></div>
        </div>

        <div id="questionSection" style="display: none;">
          <div class="question-bubble">
            <div id="questionBubble"></div>
            <div class="question-options" id="questionOptions"></div>
            <button id="continueBtn" class="continue-btn" disabled>‚û°Ô∏è Continuer √† scanner</button>
          </div>
        </div>

        <div class="progress-bar">
          <div class="progress" id="step1Progress" style="width: 0%"></div>
        </div>
        <p>Personnes scann√©es : <span id="scanCount">0</span></p>

        <div class="navigation-buttons">
          <button onclick="showStep(2)" id="goToStep2" disabled>üéÆ Lancer le d√©fi voisins</button>
        </div>
      </div>
    </div>

    <!-- √âtape 2 : D√©fi des voisins -->
    <div id="step2" class="step">
      <h2>üéÆ D√©fi des Voisins</h2>
      
      <div class="game-instructions">
        <p><strong>Objectif :</strong> Scanner 3 de vos 5 voisins les plus proches</p>
        <p><strong>R√®gles :</strong> 5 essais maximum - Moins d'erreurs = meilleur score !</p>
      </div>

      <div class="game-stats">
        <div class="score-badge" id="scoreBadge">Score: 0/3</div>
        <div class="attempts-counter">Essais restants: <span id="attemptsLeft">5</span></div>
        <div id="gameResult"></div>
      </div>

      <div class="target-list">
        <h3>üéØ Vos 5 voisins les plus proches :</h3>
        <div id="targetList"></div>
      </div>

      <div id="gameScanSection">
        <button id="gameScanBtn" class="scan-animation">üì± Scanner un voisin</button>
        <button id="gameStopScanBtn" style="display: none; background: #ff6b6b;">üõë Arr√™ter</button>
        <div id="gameScanResult"></div>
      </div>

      <div class="navigation-buttons">
        <button onclick="showStep(1)">‚¨ÖÔ∏è Retour aux rencontres</button>
        <button onclick="resetGame()" id="resetGameBtn" style="background: #ff9800;">üîÑ Recommencer le d√©fi</button>
      </div>
    </div>

    <!-- Cam√©ra -->
    <video id="video" autoplay playsinline muted style="display: none; width: 100%; border-radius: 12px;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    // Fonction utilitaire pour s√©lectionner les √©l√©ments
    function $(id) {
      return document.getElementById(id);
    }

    // G√©n√©rer un ID unique (15 caract√®res al√©atoires)
    function generateUniqueId() {
      return Math.random().toString(36).substr(2, 15);
    }

    let myCoords = null;
    let myCityName = '';
    let myFullAddress = '';
    let myUniqueId = '';
    let participants = [];
    let scanning = false;
    let animationFrameId = null;
    
    // Variables du jeu
    let gameTargets = [];
    let scannedTargets = [];
    let attemptsLeft = 5;
    let score = 0;
    let gameActive = false;

    // Questions avec choix multiples
    const questions = [
      {
        question: "Plut√¥t chien ou chat ?",
        options: ["üê∂ Chien", "üê± Chat"]
      },
      {
        question: "Plut√¥t mer ou montagne ?",
        options: ["üåä Mer", "‚õ∞Ô∏è Montagne"]
      },
      {
        question: "Plut√¥t caf√© ou th√© ?",
        options: ["‚òï Caf√©", "üçµ Th√©"]
      },
      {
        question: "Plut√¥t livre ou film ?",
        options: ["üìö Livre", "üé¨ Film"]
      },
      {
        question: "Plut√¥t sport ou d√©tente ?",
        options: ["üèÉ‚Äç‚ôÇÔ∏è Sport", "üõãÔ∏è D√©tente"]
      },
      {
        question: "Plut√¥t matin ou soir ?",
        options: ["üåÖ Matin", "üåÉ Soir"]
      },
      {
        question: "Plut√¥t sucr√© ou sal√© ?",
        options: ["üç∞ Sucr√©", "üçï Sal√©"]
      },
      {
        question: "Plut√¥t ville ou campagne ?",
        options: ["üèôÔ∏è Ville", "üå≥ Campagne"]
      },
      {
        question: "Plut√¥t √©t√© ou hiver ?",
        options: ["‚òÄÔ∏è √ât√©", "‚õÑ Hiver"]
      },
      {
        question: "Plut√¥t voyage ou maison ?",
        options: ["‚úàÔ∏è Voyage", "üè† Maison"]
      }
    ];

    // Syst√®me de scoring
    const scoreTitles = {
      0: "üéØ Expert du covoiturage !",
      1: "üöó Pro du covoiturage",
      2: "üëç Bon partenaire",
      3: "üòä D√©butant motiv√©",
      4: "ü§î En apprentissage",
      5: "üéØ √Ä retenter !"
    };

    // Afficher les erreurs
    function showError(message) {
      const errorDiv = $('errorMessage');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }

    // Afficher les succ√®s
    function showSuccess(message) {
      const successDiv = $('successMessage');
      if (successDiv) {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        setTimeout(() => {
          successDiv.style.display = 'none';
        }, 3000);
      }
    }

    // Afficher la distance
    function showDistance(distance) {
      const scanResult = $('scanResult');
      if (scanResult) {
        let emoji = 'üåü';
        if (distance < 5) emoji = 'üö∂‚Äç‚ôÇÔ∏è';
        else if (distance < 10) emoji = 'üöó';
        else if (distance < 20) emoji = 'üö≤';
        
        scanResult.innerHTML = `
          <div class="distance-info">
            ${emoji} Distance : <strong>${distance.toFixed(1)} km</strong>
          </div>
        `;
      }
    }

    // Calcul de distance
    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }

    // G√©ocodage avec gestion adresse/ville
    async function geocode(location) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&addressdetails=1`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data || data.length === 0) throw new Error('Localisation non trouv√©e');
        
        const firstResult = data[0];
        
        return { 
          lat: parseFloat(firstResult.lat), 
          lon: parseFloat(firstResult.lon), 
          displayName: firstResult.display_name,
          fullAddress: firstResult.display_name
        };
      } catch (error) {
        throw new Error('Erreur de g√©ocodage: ' + error.message);
      }
    }

    // G√©n√©ration QR Code avec ID unique
    function genMyQRCode() {
      const qrcodeElement = $('qrcode');
      if (!qrcodeElement) {
        showError('√âl√©ment QR code non trouv√©');
        return;
      }
      
      qrcodeElement.innerHTML = '';
      
      // Donn√©es : ID unique + coordonn√©es pr√©cises
      const qrData = JSON.stringify({
        id: myUniqueId,
        lat: myCoords.lat,
        lon: myCoords.lon
      });
      
      try {
        new QRCode(qrcodeElement, {
          text: qrData,
          width: 180,
          height: 180,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.L
        });
      } catch (error) {
        showError("Erreur g√©n√©ration QR code: " + error.message);
        console.error("QR Code error:", error);
      }
    }

    // Navigation entre √©tapes
    function showStep(stepNumber) {
      // Cacher toutes les √©tapes
      document.querySelectorAll('.step').forEach(step => {
        if (step) step.classList.remove('active');
      });
      document.querySelectorAll('.step-dot').forEach(dot => {
        if (dot) dot.classList.remove('active');
      });
      
      // Afficher l'√©tape demand√©e
      const stepElement = $(`step${stepNumber}`);
      const dotElement = $(`step${stepNumber}Dot`);
      
      if (stepElement) stepElement.classList.add('active');
      if (dotElement) dotElement.classList.add('active');
      
      // Arr√™ter la cam√©ra si on change d'√©tape
      stopCamera();
      
      // Initialiser le jeu si on va √† l'√©tape 2
      if (stepNumber === 2) {
        initGame();
      }
    }

    // Initialiser le jeu
    function initGame() {
      if (participants.length < 5) {
        showError("Vous devez scanner au moins 5 personnes pour jouer !");
        setTimeout(() => showStep(1), 2000);
        return;
      }
      
      // S√©lectionner les 5 plus proches
      gameTargets = participants.slice(0, 5);
      scannedTargets = [];
      attemptsLeft = 5;
      score = 0;
      gameActive = true;
      
      updateGameDisplay();
    }

    // R√©initialiser le jeu
    function resetGame() {
      initGame();
    }

    // Mettre √† jour l'affichage du jeu
    function updateGameDisplay() {
      // Mettre √† jour le score
      $('scoreBadge').textContent = `Score: ${score}/3`;
      $('attemptsLeft').textContent = attemptsLeft;
      
      // Mettre √† jour la liste des cibles
      const targetList = $('targetList');
      targetList.innerHTML = '';
      
      gameTargets.forEach((target, index) => {
        const card = document.createElement('div');
        card.className = 'participant-card';
        
        if (scannedTargets.includes(target.id)) {
          card.classList.add('scanned');
        } else {
          card.classList.add('target');
        }
        
        let medal = '';
        if (index === 0) medal = 'ü•á ';
        else if (index === 1) medal = 'ü•à ';
        else if (index === 2) medal = 'ü•â ';
        
        card.innerHTML = `
          <strong>${medal}${target.cityName}</strong>
          <span class="distance-badge">${target.distance.toFixed(1)} km</span>
          <div style="clear:both;"></div>
          ${scannedTargets.includes(target.id) ? '<small style="color:#4CAF50">‚úÖ Trouv√© !</small>' : '<small style="color:#ffd700">üéØ √Ä scanner</small>'}
        `;
        targetList.appendChild(card);
      });
      
      // V√©rifier si le jeu est termin√©
      checkGameEnd();
    }

    // V√©rifier la fin du jeu
    function checkGameEnd() {
      if (score >= 3 || attemptsLeft <= 0) {
        gameActive = false;
        const errors = (5 - attemptsLeft) - score;
        const title = scoreTitles[errors] || scoreTitles[5];
        
        $('gameResult').innerHTML = `
          <div style="color:#4CAF50; font-weight:bold; font-size:1.2rem;">
            ${title}
          </div>
          <div>
            ${score} voisins trouv√©s sur 3<br>
            ${errors} erreur(s) commise(s)
          </div>
        `;
        
        $('gameScanBtn').disabled = true;
      }
    }

    // Scanner pendant le jeu
    function handleGameScan(data) {
      if (!gameActive) return false;
      
      // V√©rifier si c'est une cible
      const targetIndex = gameTargets.findIndex(target => target.id === data.id);
      
      if (targetIndex !== -1) {
        // C'est une cible valide
        if (!scannedTargets.includes(data.id)) {
          scannedTargets.push(data.id);
          score++;
          const distance = haversineKm(myCoords.lat, myCoords.lon, data.lat, data.lon);
          showSuccess(`‚úÖ Bravo ! ${gameTargets[targetIndex].cityName} est bien un de vos voisins ! (${distance.toFixed(1)} km)`);
        } else {
          showError("‚ö†Ô∏è Vous avez d√©j√† scann√© cette personne !");
        }
      } else {
        // Ce n'est pas une cible
        showError("‚ùå Ce n'est pas un de vos 5 voisins les plus proches !");
      }
      
      attemptsLeft--;
      updateGameDisplay();
      return true;
    }

    // Afficher une question avec choix
    function showRandomQuestion() {
      const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
      const questionBubble = $('questionBubble');
      const questionOptions = $('questionOptions');
      const questionSection = $('questionSection');
      const continueBtn = $('continueBtn');
      
      if (questionBubble && questionOptions && questionSection) {
        questionBubble.textContent = randomQuestion.question;
        questionOptions.innerHTML = '';
        
        // Cr√©er les options
        randomQuestion.options.forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'question-option';
          optionDiv.textContent = option;
          optionDiv.onclick = function() {
            // D√©s√©lectionner toutes les options
            document.querySelectorAll('.question-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            // S√©lectionner cette option
            this.classList.add('selected');
            // Activer le bouton continuer
            continueBtn.disabled = false;
          };
          questionOptions.appendChild(optionDiv);
        });
        
        // R√©initialiser le bouton continuer
        continueBtn.disabled = true;
        continueBtn.onclick = function() {
          questionSection.style.display = 'none';
          // R√©activer le bouton scan
          $('scanBtn').style.display = 'block';
          $('scanBtn').classList.add('scan-animation');
        };
        
        questionSection.style.display = 'block';
        
        // Arr√™ter automatiquement la cam√©ra
        stopCamera();
      }
    }

    // Ajouter un participant avec question si <10km
    function addParticipant(data) {
      // V√©rifier par ID unique au lieu des coordonn√©es
      const existing = participants.find(p => p.id === data.id);
      if (existing) return false;
      
      const distance = haversineKm(myCoords.lat, myCoords.lon, data.lat, data.lon);
      const participant = {
        id: data.id,
        lat: data.lat,
        lon: data.lon,
        cityName: data.cityName || 'Localit√© inconnue',
        distance,
        timestamp: Date.now()
      };
      
      participants.push(participant);
      participants.sort((a, b) => a.distance - b.distance);
      
      // Mettre √† jour le compteur et la progression
      updateProgress();
      
      // Afficher la distance
      showDistance(distance);
      
      // Si distance < 10km, afficher une question
      if (distance < 10) {
        showRandomQuestion();
      }
      
      // Activer le bouton vers l'√©tape 2 si on a au moins 5 participants
      const goToStep2 = $('goToStep2');
      if (goToStep2 && participants.length >= 5) {
        goToStep2.disabled = false;
      }
      
      return true;
    }

    // Mettre √† jour la progression
    function updateProgress() {
      const scanCount = participants.length;
      const scanCountElement = $('scanCount');
      const progressElement = $('step1Progress');
      
      if (scanCountElement) {
        scanCountElement.textContent = scanCount;
      }
      
      // Progression bas√©e sur le nombre de scans (max 20 pour 100%)
      const progress = Math.min((scanCount / 20) * 100, 100);
      if (progressElement) {
        progressElement.style.width = `${progress}%`;
      }
    }

    // Gestion cam√©ra
    function stopCamera() {
      scanning = false;
      
      const stopScanBtn = $('stopScanBtn');
      const scanBtn = $('scanBtn');
      const gameStopScanBtn = $('gameStopScanBtn');
      const gameScanBtn = $('gameScanBtn');
      const video = $('video');
      
      if (stopScanBtn) stopScanBtn.style.display = 'none';
      if (scanBtn) {
        scanBtn.style.display = 'block';
        scanBtn.classList.add('scan-animation');
      }
      if (gameStopScanBtn) gameStopScanBtn.style.display = 'none';
      if (gameScanBtn) {
        gameScanBtn.style.display = 'block';
        gameScanBtn.classList.add('scan-animation');
      }
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      if (video) video.style.display = 'none';
    }

    function startScanLoop(isGame = false) {
      const video = $('video');
      const canvas = $('canvas');
      const scanBtn = isGame ? $('gameScanBtn') : $('scanBtn');
      const stopScanBtn = isGame ? $('gameStopScanBtn') : $('stopScanBtn');
      
      if (!video || !canvas) {
        showError('√âl√©ments cam√©ra non trouv√©s');
        return;
      }
      
      scanning = true;
      if (scanBtn) {
        scanBtn.style.display = 'none';
        scanBtn.classList.remove('scan-animation');
      }
      if (stopScanBtn) stopScanBtn.style.display = 'block';
      video.style.display = 'block';
      
      const ctx = canvas.getContext('2d');
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' }
      }).then(stream => {
        video.srcObject = stream;
        video.play();
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
              });
              
              if (code) {
                try {
                  // Parser les donn√©es JSON du QR code
                  const parsedData = JSON.parse(code.data);
                  
                  if (parsedData.id && parsedData.lat && parsedData.lon) {
                    if (isGame) {
                      handleGameScan(parsedData);
                    } else {
                      if (addParticipant(parsedData)) {
                        const distance = haversineKm(myCoords.lat, myCoords.lon, parsedData.lat, parsedData.lon);
                        showSuccess(`‚úÖ Connect√© !`);
                        showDistance(distance);
                      } else {
                        showError('‚ö†Ô∏è D√©j√† connect√© avec cette personne');
                      }
                    }
                    // Arr√™ter automatiquement la cam√©ra apr√®s un scan r√©ussi
                    stopCamera();
                    return;
                  }
                } catch (e) {
                  console.log('QR code invalide');
                  showError('‚ùå QR code non reconnu');
                }
              }
            } catch (error) {
              console.log('Erreur analyse QR:', error);
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        showError('Erreur acc√®s cam√©ra: ' + e.message);
        stopCamera();
      });
    }

    // √âv√©nements
    document.addEventListener('DOMContentLoaded', function() {
      const saveLocationBtn = $('saveLocation');
      const scanBtn = $('scanBtn');
      const stopScanBtn = $('stopScanBtn');
      const gameScanBtn = $('gameScanBtn');
      const gameStopScanBtn = $('gameStopScanBtn');
      const resetGameBtn = $('resetGameBtn');
      
      if (saveLocationBtn) {
        saveLocationBtn.addEventListener('click', async () => {
          const userAddress = $('userAddress');
          if (!userAddress) {
            showError('Champ adresse non trouv√©');
            return;
          }
          
          const location = userAddress.value.trim();
          if (!location) {
            showError('Entrez votre localisation');
            return;
          }
          
          try {
            const res = await geocode(location);
            myUniqueId = generateUniqueId();
            myCoords = { 
              lat: res.lat, 
              lon: res.lon
            };
            myFullAddress = res.fullAddress;
            
            // Masquer la section de saisie et afficher la section apr√®s localisation
            const locationSection = $('locationSection');
            const afterLocationSection = $('afterLocationSection');
            
            if (locationSection && afterLocationSection) {
              locationSection.style.display = 'none';
              afterLocationSection.style.display = 'block';
            }
            
            // Afficher l'adresse d√©tect√©e
            const detectedAddress = $('detectedAddress');
            if (detectedAddress) {
              detectedAddress.textContent = res.fullAddress;
            }
            
            genMyQRCode();
            showSuccess(`‚úÖ Localisation enregistr√©e ! Votre ID: ${myUniqueId}`);
            
          } catch (e) {
            showError('Erreur: ' + e.message);
          }
        });
      }
      
      if (scanBtn) {
        scanBtn.addEventListener('click', () => startScanLoop(false));
      }
      
      if (stopScanBtn) {
        stopScanBtn.addEventListener('click', stopCamera);
      }
      
      if (gameScanBtn) {
        gameScanBtn.addEventListener('click', () => startScanLoop(true));
      }
      
      if (gameStopScanBtn) {
        gameStopScanBtn.addEventListener('click', stopCamera);
      }
      
      if (resetGameBtn) {
        resetGameBtn.addEventListener('click', resetGame);
      }
    });

    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
