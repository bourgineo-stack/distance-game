<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Distance entre deux villes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      margin: 16px;
      padding: 0;
      background-color: #f9f9f9;
      color: #222;
    }
    input, button {
      padding: 12px 16px;
      margin: 8px 4px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      display: inline-block;
      width: auto;
      max-width: 90%;
    }
    #qrcode {
      display: none;
      margin: 24px auto;
      width: 180px;
      height: 180px;
      padding: 0;
      background-color: transparent;
    }
    #scanBtn, #stopScanBtn {
      display: block;
      margin: 16px auto;
      width: 180px;
    }
    #stopScanBtn {
      display: none;
      background-color: #ff4444;
      color: white;
    }
    #video {
      width: 100%;
      max-width: 420px;
      margin: 12px auto;
      display: none;
      border-radius: 8px;
      background: #000;
      transform: rotateY(180deg); /* Miroir pour un effet plus naturel */
    }
    #canvas { display: none; }
    #result {
      display: block;
      margin: 16px auto;
      font-weight: bold;
      min-height: 1.4em;
      font-size: 1rem;
      color: #004085;
    }
    h2 { font-size: 1.4rem; margin-bottom: 12px; }
    .scanning-message {
      display: none;
      color: #666;
      font-style: italic;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h2>Distance entre deux villes</h2>
  <input id="city" placeholder="Entrez votre ville" />
  <button id="saveCity">Valider ma ville</button>
  <div id="result"></div>
  <div id="qrcode"></div>
  <button id="scanBtn" disabled>Scanner un QR code</button>
  <button id="stopScanBtn">Arrêter le scan</button>
  <div class="scanning-message" id="scanningMessage">Recherche de QR code...</div>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let myCoords = null;
    let otherCoords = null;
    let scanning = false;
    let animationFrameId = null;
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');

    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }

    async function geocode(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.length === 0) throw new Error('Ville non trouvée');
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name };
    }

    function genMyQRCode() {
      $('qrcode').style.display = 'block';
      $('qrcode').innerHTML = '';
      new QRCode($('qrcode'), {
        text: JSON.stringify({ lat: myCoords.lat, lon: myCoords.lon }),
        width: 180,
        height: 180,
        colorDark: '#000000',
        colorLight: '#ffffff',
      });
    }

    function stopCamera() {
      scanning = false;
      $('scanningMessage').style.display = 'none';
      $('stopScanBtn').style.display = 'none';
      $('scanBtn').style.display = 'block';
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => {
          track.stop();
        });
        video.srcObject = null;
      }
      
      video.style.display = 'none';
      
      // Forcer un redessin pour iOS
      setTimeout(() => {
        document.body.style.display = 'none';
        setTimeout(() => {
          document.body.style.display = 'block';
        }, 50);
      }, 100);
    }

    function startScanLoop() {
      scanning = true;
      $('scanBtn').style.display = 'none';
      $('stopScanBtn').style.display = 'block';
      $('scanningMessage').style.display = 'block';
      video.style.display = 'block';
      
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      }).then(stream => {
        video.srcObject = stream;
        video.play();
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
              });
              
              if (code) {
                try {
                  const parsed = JSON.parse(code.data);
                  if (parsed.lat && parsed.lon) {
                    otherCoords = { lat: parsed.lat, lon: parsed.lon };
                    const d = haversineKm(myCoords.lat, myCoords.lon, otherCoords.lat, otherCoords.lon);
                    $('result').textContent = `Distance : ${d.toFixed(1)} km`;
                    
                    // Arrêter le scan automatiquement après détection
                    setTimeout(() => {
                      stopCamera();
                    }, 500);
                    return;
                  }
                } catch (e) {
                  console.log('QR code invalide');
                }
              }
            } catch (error) {
              console.log('Erreur analyse QR:', error);
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        alert('Erreur accès caméra: ' + e);
        stopCamera();
      });
    }

    $('saveCity').addEventListener('click', async () => {
      const city = $('city').value.trim();
      if (!city) {
        alert('Entrez une ville');
        return;
      }
      $('result').textContent = 'Recherche…';
      try {
        const res = await geocode(city);
        myCoords = { lat: res.lat, lon: res.lon };
        genMyQRCode();
        $('scanBtn').disabled = false;
        $('result').textContent = `Ville enregistrée : ${res.name.split(',')[0]}`;
      } catch (e) {
        alert('Erreur: ' + e);
        $('result').textContent = '';
      }
    });

    $('scanBtn').addEventListener('click', () => {
      if (myCoords) startScanLoop();
      else alert('Commencez par saisir votre ville');
    });

    $('stopScanBtn').addEventListener('click', stopCamera);

    // Gérer la fermeture de la page
    window.addEventListener('beforeunload', stopCamera);
    window.addEventListener('pagehide', stopCamera);
  </script>
</body>
</html>
