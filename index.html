<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connectez-vous par la distance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      margin: 16px;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    input, button {
      padding: 15px 20px;
      margin: 10px 5px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      display: inline-block;
      width: 100%;
      max-width: 300px;
    }
    input {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }
    button {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #cccccc;
      transform: none;
    }
    #qrcode {
      display: none;
      margin: 24px auto;
      width: 200px;
      height: 200px;
      padding: 10px;
      background: white;
      border-radius: 12px;
    }
    #scanBtn, #stopScanBtn {
      width: 200px;
      margin: 10px auto;
    }
    #stopScanBtn {
      display: none;
      background-color: #ff6b6b;
    }
    #video {
      width: 100%;
      max-width: 300px;
      margin: 12px auto;
      display: none;
      border-radius: 12px;
      background: #000;
      transform: rotateY(180deg);
    }
    #canvas { display: none; }
    #result {
      margin: 20px auto;
      font-weight: bold;
      min-height: 1.4em;
      font-size: 1.2rem;
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
    }
    h2 { 
      font-size: 1.8rem; 
      margin-bottom: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .scanning-message {
      display: none;
      color: #fff;
      font-style: italic;
      margin: 15px 0;
    }
    .participants-list {
      display: none;
      margin-top: 20px;
      text-align: left;
    }
    .participant-item {
      background: rgba(255, 255, 255, 0.15);
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }
    .distance-badge {
      background: #ffd700;
      color: #333;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      float: right;
    }
    .close-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      float: right;
      cursor: pointer;
      width: auto;
      margin: 0;
      padding: 0 10px;
    }
    .stats {
      display: none;
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
    }
    .carpool-suggestion {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4CAF50;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      display: none;
    }
    .section-title {
      font-size: 1.3rem;
      margin: 25px 0 15px 0;
      text-align: left;
      border-bottom: 2px solid rgba(255,255,255,0.3);
      padding-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üöó Connectez-vous !</h2>
    <p>Entrez votre ville et scannez les QR codes des autres participants pour d√©couvrir vos voisins !</p>
    
    <input id="city" placeholder="üìç Entrez votre ville" />
    <button id="saveCity">Valider ma ville</button>
    
    <div id="result"></div>
    
    <div id="qrcode"></div>
    
    <button id="scanBtn" disabled>üì± Scanner un QR code</button>
    <button id="stopScanBtn">üõë Arr√™ter le scan</button>
    <div class="scanning-message" id="scanningMessage">Recherche de QR code...</div>
    
    <div class="stats" id="stats">
      <div class="section-title">üìä Vos statistiques</div>
      <div id="statsContent"></div>
    </div>
    
    <div class="carpool-suggestion" id="carpoolSuggestion">
      <div class="section-title">ü§ù Suggestions covoiturage</div>
      <div id="carpoolContent"></div>
    </div>
    
    <div class="participants-list" id="participantsList">
      <div class="section-title">üë• Participants rencontr√©s</div>
      <div id="participantsContainer"></div>
    </div>
    
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let myCoords = null;
    let myCityName = '';
    let participants = [];
    let scanning = false;
    let animationFrameId = null;
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');

    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }

    async function geocode(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.length === 0) throw new Error('Ville non trouv√©e');
      return { 
        lat: parseFloat(data[0].lat), 
        lon: parseFloat(data[0].lon), 
        name: data[0].display_name.split(',')[0] 
      };
    }

    function genMyQRCode() {
      $('qrcode').style.display = 'block';
      $('qrcode').innerHTML = '';
      new QRCode($('qrcode'), {
        text: JSON.stringify({ 
          lat: myCoords.lat, 
          lon: myCoords.lon,
          city: myCityName,
          timestamp: Date.now()
        }),
        width: 180,
        height: 180,
        colorDark: '#000000',
        colorLight: '#ffffff',
      });
    }

    function addParticipant(lat, lon, cityName) {
      // √âviter les doublons
      const existing = participants.find(p => 
        p.lat === lat && p.lon === lon
      );
      
      if (existing) {
        return false; // D√©j√† dans la liste
      }
      
      const distance = haversineKm(myCoords.lat, myCoords.lon, lat, lon);
      const participant = {
        lat,
        lon,
        cityName,
        distance,
        timestamp: Date.now()
      };
      
      participants.push(participant);
      participants.sort((a, b) => a.distance - b.distance);
      
      updateParticipantsList();
      updateStats();
      updateCarpoolSuggestions();
      
      return true;
    }

    function updateParticipantsList() {
      const container = $('participantsContainer');
      container.innerHTML = '';
      
      if (participants.length === 0) {
        container.innerHTML = '<p style="text-align:center;">Aucun participant rencontr√© encore</p>';
        $('participantsList').style.display = 'none';
        return;
      }
      
      $('participantsList').style.display = 'block';
      
      participants.forEach((participant, index) => {
        const item = document.createElement('div');
        item.className = 'participant-item';
        item.innerHTML = `
          <button class="close-btn" onclick="removeParticipant(${index})">√ó</button>
          <strong>${participant.cityName}</strong>
          <span class="distance-badge">${participant.distance.toFixed(1)} km</span>
          <div style="clear:both;"></div>
        `;
        container.appendChild(item);
      });
    }

    function removeParticipant(index) {
      participants.splice(index, 1);
      updateParticipantsList();
      updateStats();
      updateCarpoolSuggestions();
    }

    function updateStats() {
      const statsContent = $('statsContent');
      
      if (participants.length === 0) {
        $('stats').style.display = 'none';
        return;
      }
      
      $('stats').style.display = 'block';
      
      const closest = participants[0];
      const totalDistance = participants.reduce((sum, p) => sum + p.distance, 0);
      const averageDistance = totalDistance / participants.length;
      
      statsContent.innerHTML = `
        <p>üë• <strong>${participants.length}</strong> participant(s) rencontr√©(s)</p>
        <p>üìç Plus proche: <strong>${closest.cityName}</strong> (${closest.distance.toFixed(1)} km)</p>
        <p>üìè Distance moyenne: <strong>${averageDistance.toFixed(1)} km</strong></p>
      `;
    }

    function updateCarpoolSuggestions() {
      const carpoolContent = $('carpoolContent');
      const closeParticipants = participants.filter(p => p.distance < 20);
      
      if (closeParticipants.length === 0) {
        $('carpoolSuggestion').style.display = 'none';
        return;
      }
      
      $('carpoolSuggestion').style.display = 'block';
      
      let suggestions = '<p>Vous habitez pr√®s de :</p>';
      closeParticipants.forEach(p => {
        let emoji = 'üè†';
        if (p.distance < 5) emoji = 'üö∂‚Äç‚ôÇÔ∏è';
        else if (p.distance < 10) emoji = 'üö≤';
        else emoji = 'üöó';
        
        suggestions += `<p>${emoji} <strong>${p.cityName}</strong> - ${p.distance.toFixed(1)} km</p>`;
      });
      
      suggestions += '<p><em>N\'h√©sitez pas √† leur proposer du covoiturage !</em></p>';
      carpoolContent.innerHTML = suggestions;
    }

    function stopCamera() {
      scanning = false;
      $('scanningMessage').style.display = 'none';
      $('stopScanBtn').style.display = 'none';
      $('scanBtn').style.display = 'block';
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => {
          track.stop();
        });
        video.srcObject = null;
      }
      
      video.style.display = 'none';
      
      setTimeout(() => {
        document.body.style.display = 'none';
        setTimeout(() => {
          document.body.style.display = 'block';
        }, 50);
      }, 100);
    }

    function startScanLoop() {
      scanning = true;
      $('scanBtn').style.display = 'none';
      $('stopScanBtn').style.display = 'block';
      $('scanningMessage').style.display = 'block';
      video.style.display = 'block';
      
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'environment',
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      }).then(stream => {
        video.srcObject = stream;
        video.play();
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
              });
              
              if (code) {
                try {
                  const parsed = JSON.parse(code.data);
                  if (parsed.lat && parsed.lon) {
                    const cityName = parsed.city || 'Ville inconnue';
                    
                    // Ajouter le participant
                    const added = addParticipant(parsed.lat, parsed.lon, cityName);
                    
                    if (added) {
                      // Afficher un message de succ√®s
                      const distance = haversineKm(myCoords.lat, myCoords.lon, parsed.lat, parsed.lon);
                      $('result').innerHTML = `
                        <div style="color:#4CAF50;">
                          ‚úÖ <strong>Connect√© avec ${cityName} !</strong><br>
                          Distance: ${distance.toFixed(1)} km
                        </div>
                      `;
                      
                      // Continuer √† scanner apr√®s un court d√©lai
                      setTimeout(() => {
                        $('result').innerHTML = 'Pr√™t √† scanner un autre QR code';
                      }, 3000);
                    } else {
                      $('result').innerHTML = `
                        <div style="color:#ff9800;">
                          ‚ö†Ô∏è D√©j√† connect√© avec ${cityName}
                        </div>
                      `;
                    }
                    
                    return;
                  }
                } catch (e) {
                  console.log('QR code invalide');
                }
              }
            } catch (error) {
              console.log('Erreur analyse QR:', error);
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        alert('Erreur acc√®s cam√©ra: ' + e);
        stopCamera();
      });
    }

    // √âv√©nements
    $('saveCity').addEventListener('click', async () => {
      const city = $('city').value.trim();
      if (!city) {
        alert('Entrez une ville');
        return;
      }
      $('result').innerHTML = 'üîç Recherche en cours...';
      try {
        const res = await geocode(city);
        myCoords = { lat: res.lat, lon: res.lon };
        myCityName = res.name;
        genMyQRCode();
        $('scanBtn').disabled = false;
        $('result').innerHTML = `
          <div style="color:#4CAF50;">
            ‚úÖ Ville enregistr√©e : <strong>${res.name}</strong>
          </div>
        `;
      } catch (e) {
        alert('Erreur: ' + e);
        $('result').innerHTML = '';
      }
    });

    $('scanBtn').addEventListener('click', () => {
      if (myCoords) startScanLoop();
      else alert('Commencez par saisir votre ville');
    });

    $('stopScanBtn').addEventListener('click', stopCamera);

    // G√©rer la fermeture de la page
    window.addEventListener('beforeunload', stopCamera);
    window.addEventListener('pagehide', stopCamera);
  </script>
</body>
</html>
