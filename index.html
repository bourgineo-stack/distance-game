<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©seau de proximit√©</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    input, button {
      padding: 15px 20px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      width: 100%;
    }
    input {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }
    button {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #cccccc; }
    #qrcode {
      margin: 20px auto;
      width: 200px;
      height: 200px;
      padding: 10px;
      background: white;
      border-radius: 12px;
    }
    .section {
      background: rgba(255, 255, 255, 0.15);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      display: none;
    }
    .participant-card {
      background: rgba(255, 255, 255, 0.2);
      margin: 10px 0;
      padding: 15px;
      border-radius: 12px;
      border-left: 4px solid #4CAF50;
    }
    .distance-badge {
      background: #ffd700;
      color: #333;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      float: right;
    }
    .close-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
      float: right;
      cursor: pointer;
      margin: -10px -10px 0 0;
      padding: 5px 10px;
    }
    .tab-container {
      display: flex;
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .tab.active {
      background: rgba(76, 175, 80, 0.3);
      font-weight: bold;
    }
    .carpool-group {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4CAF50;
      border-radius: 12px;
      padding: 15px;
      margin: 10px 0;
    }
    .search-bar {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      color: white;
      width: 100%;
      margin-bottom: 15px;
    }
    .search-bar::placeholder { color: rgba(255, 255, 255, 0.7); }
    h2 { text-align: center; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ü§ù R√©seau de proximit√©</h2>
    
    <!-- √âtape 1 : Saisie de la ville -->
    <div id="setupSection">
      <p>Commencez par indiquer votre ville pour g√©n√©rer votre code de connexion</p>
      <input id="city" placeholder="üìç Entrez votre ville" />
      <button id="saveCity">Valider ma ville</button>
    </div>

    <!-- Interface principale apr√®s configuration -->
    <div id="mainSection" style="display: none;">
      <div class="tab-container">
        <div class="tab active" onclick="showTab('proximite')">üìç Proximit√©</div>
        <div class="tab" onclick="showTab('liste')">üë• Tous les contacts</div>
        <div class="tab" onclick="showTab('monCode')">üì± Mon code</div>
      </div>

      <!-- Tab 1 : Vue par proximit√© -->
      <div id="proximite" class="tab-content">
        <input type="text" class="search-bar" placeholder="üîç Rechercher une ville..." onkeyup="filterParticipants(this.value)">
        
        <div class="carpool-group">
          <h4>üöó Covoiturage facile (moins de 10km)</h4>
          <div id="carpoolList"></div>
        </div>
        
        <div class="carpool-group" style="background: rgba(255, 152, 0, 0.3); border-color: #ff9800;">
          <h4>üö≤ Distance v√©lo (10-20km)</h4>
          <div id="bikeList"></div>
        </div>
        
        <div class="carpool-group" style="background: rgba(33, 150, 243, 0.3); border-color: #2196f3;">
          <h4>üåü Dans la r√©gion (20-50km)</h4>
          <div id="regionList"></div>
        </div>
      </div>

      <!-- Tab 2 : Liste compl√®te -->
      <div id="liste" class="tab-content" style="display: none;">
        <input type="text" class="search-bar" placeholder="üîç Rechercher un contact..." onkeyup="filterAllParticipants(this.value)">
        <div id="allParticipantsList"></div>
      </div>

      <!-- Tab 3 : Mon QR Code -->
      <div id="monCode" class="tab-content" style="display: none;">
        <p>Partagez ce code avec les autres participants :</p>
        <div id="qrcode"></div>
        <button id="scanBtn">üì± Scanner un code</button>
        <button id="stopScanBtn" style="display: none; background: #ff6b6b;">üõë Arr√™ter le scan</button>
        <div id="scanningMessage" style="display: none; text-align: center; margin: 10px 0;">Recherche de code...</div>
      </div>
    </div>

    <!-- Cam√©ra pour scanning -->
    <video id="video" autoplay playsinline muted style="display: none; width: 100%; border-radius: 12px;"></video>
    <canvas id="canvas" style="display: none;"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let myCoords = null;
    let myCityName = '';
    let participants = [];
    let scanning = false;
    let animationFrameId = null;
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');

    // Calcul de distance
    function haversineKm(aLat, aLon, bLat, bLon) {
      const R = 6371;
      const dLat = (bLat - aLat) * Math.PI / 180;
      const dLon = (bLon - aLon) * Math.PI / 180;
      const A = Math.sin(dLat / 2) ** 2 + Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    }

    // G√©ocodage
    async function geocode(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data || data.length === 0) throw new Error('Ville non trouv√©e');
      return { 
        lat: parseFloat(data[0].lat), 
        lon: parseFloat(data[0].lon), 
        name: data[0].display_name.split(',')[0] 
      };
    }

    // G√©n√©ration QR Code
    function genMyQRCode() {
      $('qrcode').innerHTML = '';
      new QRCode($('qrcode'), {
        text: JSON.stringify({ 
          lat: myCoords.lat, 
          lon: myCoords.lon,
          city: myCityName,
          timestamp: Date.now()
        }),
        width: 180,
        height: 180,
        colorDark: '#000000',
        colorLight: '#ffffff',
      });
    }

    // Navigation par onglets
    function showTab(tabName) {
      // D√©sactiver tous les onglets
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
      
      // Activer l'onglet s√©lectionn√©
      event.target.classList.add('active');
      $(tabName).style.display = 'block';
      
      // Arr√™ter la cam√©ra si on quitte l'onglet scan
      if (tabName !== 'monCode') {
        stopCamera();
      }
    }

    // Ajouter un participant
    function addParticipant(lat, lon, cityName) {
      // √âviter les doublons
      const existing = participants.find(p => p.cityName === cityName);
      if (existing) return false;
      
      const distance = haversineKm(myCoords.lat, myCoords.lon, lat, lon);
      const participant = {
        lat,
        lon,
        cityName,
        distance,
        timestamp: Date.now(),
        id: Math.random().toString(36).substr(2, 9)
      };
      
      participants.push(participant);
      participants.sort((a, b) => a.distance - b.distance);
      
      updateAllDisplays();
      return true;
    }

    // Mettre √† jour toutes les vues
    function updateAllDisplays() {
      updateProximityView();
      updateAllParticipantsList();
    }

    // Vue par proximit√©
    function updateProximityView() {
      const carpoolList = $('#carpoolList');
      const bikeList = $('#bikeList');
      const regionList = $('#regionList');
      
      carpoolList.innerHTML = '';
      bikeList.innerHTML = '';
      regionList.innerHTML = '';
      
      participants.forEach(participant => {
        const card = createParticipantCard(participant);
        
        if (participant.distance < 10) {
          carpoolList.appendChild(card);
        } else if (participant.distance < 20) {
          bikeList.appendChild(card);
        } else if (participant.distance < 50) {
          regionList.appendChild(card);
        }
      });
    }

    // Liste compl√®te
    function updateAllParticipantsList() {
      const container = $('#allParticipantsList');
      container.innerHTML = '';
      
      participants.forEach(participant => {
        container.appendChild(createParticipantCard(participant));
      });
    }

    // Cr√©er une carte participant
    function createParticipantCard(participant) {
      const card = document.createElement('div');
      card.className = 'participant-card';
      card.dataset.city = participant.cityName.toLowerCase();
      
      let emoji = 'üåü';
      if (participant.distance < 5) emoji = 'üö∂‚Äç‚ôÇÔ∏è';
      else if (participant.distance < 10) emoji = 'üöó';
      else if (participant.distance < 20) emoji = 'üö≤';
      
      card.innerHTML = `
        <button class="close-btn" onclick="removeParticipant('${participant.id}')">√ó</button>
        <strong>${emoji} ${participant.cityName}</strong>
        <span class="distance-badge">${participant.distance.toFixed(1)} km</span>
        <div style="clear:both;"></div>
        <small>Rencontr√© √† ${new Date(participant.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</small>
      `;
      
      return card;
    }

    // Filtrer les participants
    function filterParticipants(searchTerm) {
      const cards = document.querySelectorAll('#proximite .participant-card');
      cards.forEach(card => {
        const matches = card.dataset.city.includes(searchTerm.toLowerCase());
        card.style.display = matches ? 'block' : 'none';
      });
    }

    function filterAllParticipants(searchTerm) {
      const cards = document.querySelectorAll('#liste .participant-card');
      cards.forEach(card => {
        const matches = card.dataset.city.includes(searchTerm.toLowerCase());
        card.style.display = matches ? 'block' : 'none';
      });
    }

    // Supprimer un participant
    function removeParticipant(id) {
      participants = participants.filter(p => p.id !== id);
      updateAllDisplays();
    }

    // Gestion cam√©ra
    function stopCamera() {
      scanning = false;
      $('#scanningMessage').style.display = 'none';
      $('#stopScanBtn').style.display = 'none';
      $('#scanBtn').style.display = 'block';
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      video.style.display = 'none';
    }

    function startScanLoop() {
      scanning = true;
      $('#scanBtn').style.display = 'none';
      $('#stopScanBtn').style.display = 'block';
      $('#scanningMessage').style.display = 'block';
      video.style.display = 'block';
      
      navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' }
      }).then(stream => {
        video.srcObject = stream;
        video.play();
        
        const scan = () => {
          if (!scanning) return;
          
          if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            try {
              const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: 'dontInvert',
              });
              
              if (code) {
                try {
                  const parsed = JSON.parse(code.data);
                  if (parsed.lat && parsed.lon) {
                    const cityName = parsed.city || 'Ville inconnue';
                    
                    if (addParticipant(parsed.lat, parsed.lon, cityName)) {
                      // Succ√®s - retour √† l'onglet proximit√©
                      showTab('proximite');
                      stopCamera();
                    }
                    return;
                  }
                } catch (e) {
                  console.log('QR code invalide');
                }
              }
            } catch (error) {
              console.log('Erreur analyse QR:', error);
            }
          }
          
          animationFrameId = requestAnimationFrame(scan);
        };
        
        animationFrameId = requestAnimationFrame(scan);
      }).catch(e => {
        alert('Erreur acc√®s cam√©ra: ' + e);
        stopCamera();
      });
    }

    // √âv√©nements
    $('saveCity').addEventListener('click', async () => {
      const city = $('city').value.trim();
      if (!city) {
        alert('Entrez une ville');
        return;
      }
      
      try {
        const res = await geocode(city);
        myCoords = { lat: res.lat, lon: res.lon };
        myCityName = res.name;
        
        $('setupSection').style.display = 'none';
        $('mainSection').style.display = 'block';
        genMyQRCode();
        
      } catch (e) {
        alert('Erreur: ' + e);
      }
    });

    $('scanBtn').addEventListener('click', startScanLoop);
    $('stopScanBtn').addEventListener('click', stopCamera);

    window.addEventListener('beforeunload', stopCamera);
  </script>
</body>
</html>
